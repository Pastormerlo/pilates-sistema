{% extends 'layout.html' %}
{% block content %}
<style>
    /* --- VISTA PARA PC --- */
    @media (min-width: 768px) {
        .table-agenda { table-layout: fixed; border-spacing: 1px; display: table; }
        .vista-celu { display: none; }
    }

    /* --- VISTA PARA CELULAR --- */
    @media (max-width: 767px) {
        .table-agenda { display: none; } 
        .vista-celu { display: block; }
        .dia-card { margin-bottom: 15px; border-radius: 8px; overflow: hidden; border: 1px solid #dee2e6; background: #fff; }
        .dia-header { background: #212529; color: white; padding: 10px; font-weight: bold; text-align: center; }
        .hora-row { display: flex; align-items: flex-start; padding: 10px; border-bottom: 1px solid #f0f0f0; }
        .hora-label { width: 55px; font-weight: bold; font-size: 0.85rem; color: #495057; padding-top: 5px; }
        .contenido-turno { flex-grow: 1; }
    }

    /* Estilos generales de los chips */
    .alumno-chip {
        font-size: 0.85rem;
        padding: 6px 10px;
        background-color: #f8f9fa;
        border-left: 4px solid #0d6efd;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
        color: #212529;
        border: 1px solid #e9ecef;
    }
    .turno-completo-bg { background-color: #198754 !important; color: white !important; }
</style>

<div class="card border-0 shadow-sm mb-3">
    <div class="card-body p-2 px-3 d-flex justify-content-between align-items-center">
        <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-calendar-alt me-2 text-primary"></i>Agenda</h6>
        <div class="btn-group shadow-sm">
            <a href="/agenda?fecha={{ (inicio - timedelta(days=7)).strftime('%Y-%m-%d') }}" class="btn btn-white btn-sm border"><i class="fas fa-chevron-left"></i></a>
            <span class="btn btn-white btn-sm border fw-bold small text-primary">{{ inicio.strftime('%d/%m') }}</span>
            <a href="/agenda?fecha={{ (inicio + timedelta(days=7)).strftime('%Y-%m-%d') }}" class="btn btn-white btn-sm border"><i class="fas fa-chevron-right"></i></a>
        </div>
        <button class="btn btn-primary btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#modalTurno">
            <i class="fas fa-plus me-1"></i> NUEVO
        </button>
    </div>
</div>

<div class="table-responsive shadow-sm rounded d-none d-md-block">
    <table class="table table-agenda mb-0 bg-white">
        <thead class="bg-dark text-white text-center">
            <tr>
                <th style="width:75px;">HORA</th>
                {% for d in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'] %}<th>{{ d }}</th>{% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for h in horarios %}
            <tr>
                <td class="text-center fw-bold bg-light small align-middle">{{ h }}</td>
                {% for dia in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'] %}
                    <td class="celda-turno drop-zone" data-dia="{{ dia }}" data-hora="{{ h }}" style="min-height:70px; border:1px solid #f0f0f0;">
                        {% set alumnos_turno = [] %}
                        {% for t in turnos %}{% if t.dia_semana == dia and (t.hora.strftime('%H:%M') if t.hora.strftime else t.hora) == h %}{% set _ = alumnos_turno.append(t) %}{% endif %}{% endfor %}
                        
                        <details>
                            <summary class="p-2 text-center small fw-bold {{ 'text-success' if alumnos_turno|length >= 6 else 'text-primary' if alumnos_turno|length > 0 else 'text-muted' }}">
                                {{ alumnos_turno|length }}/6
                            </summary>
                            <div class="p-1">
                                {% for t in alumnos_turno %}
                                <div class="alumno-chip draggable" draggable="true" data-id="{{ t.id }}">
                                    <span class="text-truncate" style="max-width: 70px;">{{ t.apellido }}</span>
                                    <a href="/eliminar_turno/{{ t.id }}?fecha_ref={{ inicio.strftime('%Y-%m-%d') }}" class="text-danger">×</a>
                                </div>
                                {% endfor %}
                            </div>
                        </details>
                    </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="vista-celu">
    {% for dia in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'] %}
    <div class="dia-card shadow-sm">
        <div class="dia-header">{{ dia }}</div>
        {% for h in horarios %}
            {% set alumnos_turno = [] %}
            {% for t in turnos %}{% if t.dia_semana == dia and (t.hora.strftime('%H:%M') if t.hora.strftime else t.hora) == h %}{% set _ = alumnos_turno.append(t) %}{% endif %}{% endfor %}
            
            {% if alumnos_turno|length > 0 %}
            <div class="hora-row">
                <div class="hora-label">{{ h }}</div>
                <div class="contenido-turno">
                    {% for t in alumnos_turno %}
                    <div class="alumno-chip">
                        <span class="fw-bold">{{ t.apellido }}, {{ t.nombre }}</span>
                        <a href="/eliminar_turno/{{ t.id }}?fecha_ref={{ inicio.strftime('%Y-%m-%d') }}" class="text-danger ms-2"><i class="fas fa-times-circle"></i></a>
                    </div>
                    {% endfor %}
                    <div class="text-end"><small class="badge {{ 'bg-success' if alumnos_turno|length >= 6 else 'bg-light text-dark border' }}">{{ alumnos_turno|length }} de 6 alumnos</small></div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
    {% endfor %}
</div>

<div class="modal fade" id="modalTurno" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <form action="/agregar_turno" method="POST">
                <input type="hidden" name="fecha_inicio" value="{{ inicio.strftime('%Y-%m-%d') }}">
                <div class="modal-header bg-primary text-white py-2">
                    <h6 class="modal-title fw-bold">Nuevo Turno</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3">
                    <div class="mb-3">
                        <label class="small fw-bold">Alumno</label>
                        <select name="alumno_id" class="form-select" required>
                            {% for a in alumnos %}<option value="{{ a.id }}">{{ a.apellido }}, {{ a.nombre }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="small fw-bold">Día</label>
                            <select name="dia_semana" class="form-select">
                                {% for d in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'] %}<option value="{{ d }}">{{ d }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="small fw-bold">Hora</label>
                            <select name="hora" class="form-select">
                                {% for h in horarios %}<option value="{{ h }}">{{ h }} hs</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">AGENDAR</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const draggables = document.querySelectorAll('.draggable');
    const containers = document.querySelectorAll('.drop-zone');
    draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', () => draggable.classList.add('dragging'));
        draggable.addEventListener('dragend', () => draggable.classList.remove('dragging'));
    });
    containers.forEach(container => {
        container.addEventListener('dragover', e => e.preventDefault());
        container.addEventListener('drop', e => {
            e.preventDefault();
            const draggable = document.querySelector('.dragging');
            if(!draggable) return;
            fetch('/mover_turno', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    id: draggable.getAttribute('data-id'),
                    dia_semana: container.getAttribute('data-dia'),
                    hora: container.getAttribute('data-hora')
                })
            }).then(() => location.reload());
        });
    });
</script>
{% endblock %}