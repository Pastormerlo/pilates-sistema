{% extends 'layout.html' %}
{% block content %}
<style>
    .table-agenda { table-layout: fixed; border-spacing: 1px; }
    .table-agenda th {
        font-size: 0.7rem;
        background-color: #212529 !important;
        color: white;
        text-align: center;
        padding: 5px;
    }
    .col-hora { width: 60px !important; background-color: #f8f9fa; }
    
    .celda-turno {
        vertical-align: top;
        background-color: #ffffff;
        border: 1px solid #f0f0f0;
        padding: 0 !important; /* Quitamos padding para que el desplegable ocupe todo */
    }

    /* Estilo del Desplegable */
    details {
        width: 100%;
        cursor: pointer;
    }
    summary {
        padding: 10px 5px;
        font-size: 0.75rem;
        font-weight: bold;
        text-align: center;
        list-style: none; /* Quita la flechita por defecto */
        transition: background 0.3s;
    }
    summary::-webkit-details-marker { display: none; } /* Quita flecha en Safari */

    /* Colores según estado */
    .turno-vacio { color: #adb5bd; }
    .turno-con-gente { background-color: #e7f1ff; color: #0d6efd; }
    .turno-completo { background-color: #198754; color: white; }

    .lista-desplegada {
        padding: 5px;
        background-color: white;
        border-top: 1px solid #eee;
    }

    .alumno-chip {
        font-size: 0.65rem;
        padding: 3px 6px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 3px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 3px;
    }
    .alumno-chip:hover { background-color: #e9ecef; }
</style>

<div class="card border-0 shadow-sm mb-3 no-print">
    <div class="card-body p-2 px-3 d-flex justify-content-between align-items-center">
        <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-list-ul me-2 text-primary"></i>Agenda Compacta</h6>
        <div class="btn-group shadow-sm">
            <a href="/agenda?fecha={{ (inicio - timedelta(days=7)).strftime('%Y-%m-%d') }}" class="btn btn-light btn-sm border"><i class="fas fa-chevron-left"></i></a>
            <span class="btn btn-light btn-sm border fw-bold small text-primary">{{ inicio.strftime('%d/%m') }}</span>
            <a href="/agenda?fecha={{ (inicio + timedelta(days=7)).strftime('%Y-%m-%d') }}" class="btn btn-light btn-sm border"><i class="fas fa-chevron-right"></i></a>
        </div>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalTurno">
            <i class="fas fa-plus"></i>
        </button>
    </div>
</div>

<div class="table-responsive shadow-sm rounded">
    <table class="table table-agenda mb-0 bg-white">
        <thead>
            <tr>
                <th class="col-hora">HORA</th>
                {% for d in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'] %}<th>{{ d }}</th>{% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for h in horarios %}
            <tr>
                <td class="text-center fw-bold align-middle bg-light" style="font-size: 0.75rem;">{{ h }}</td>
                {% for dia in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'] %}
                    <td class="celda-turno drop-zone" data-dia="{{ dia }}" data-hora="{{ h }}">
                        
                        {% set alumnos_en_este_turno = [] %}
                        {% for t in turnos %}
                            {% set hora_turno = t.hora.strftime('%H:%M') if t.hora.strftime else t.hora %}
                            {% if t.dia_semana == dia and hora_turno == h %}
                                {% set _ = alumnos_en_este_turno.append(t) %}
                            {% endif %}
                        {% endfor %}

                        {% set cant = alumnos_en_este_turno|length %}

                        <details>
                            <summary class="{% if cant == 0 %}turno-vacio{% elif cant >= 6 %}turno-completo{% else %}turno-con-gente{% endif %}">
                                {% if cant == 0 %}
                                    <small>Vacío</small>
                                {% elif cant >= 6 %}
                                    <i class="fas fa-check-circle me-1"></i> COMPLETO
                                {% else %}
                                    {{ cant }} Alumno{% if cant > 1 %}s{% endif %}
                                {% endif %}
                            </summary>
                            
                            <div class="lista-desplegada">
                                {% if cant > 0 %}
                                    {% for t in alumnos_en_este_turno %}
                                    <div class="alumno-chip draggable" draggable="true" data-id="{{ t.id }}">
                                        <span class="text-truncate">{{ t.apellido }}</span>
                                        <a href="/eliminar_turno/{{ t.id }}?fecha_ref={{ inicio.strftime('%Y-%m-%d') }}" class="text-danger ms-1" style="text-decoration:none;">×</a>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center py-2 text-muted" style="font-size: 0.6rem;">Sin alumnos</div>
                                {% endif %}
                            </div>
                        </details>
                    </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="modalTurno" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <form action="/agregar_turno" method="POST">
                <input type="hidden" name="fecha_inicio" value="{{ inicio.strftime('%Y-%m-%d') }}">
                <div class="modal-header bg-primary text-white py-2">
                    <h6 class="modal-title fw-bold">Asignar Alumno</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Alumno</label>
                        <select name="alumno_id" class="form-select" required>
                            {% for a in alumnos %}<option value="{{ a.id }}">{{ a.apellido }}, {{ a.nombre }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label small fw-bold">Día</label>
                            <select name="dia_semana" class="form-select">
                                {% for d in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'] %}<option value="{{ d }}">{{ d }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold">Hora</label>
                            <select name="hora" class="form-select">
                                {% for h in horarios %}<option value="{{ h }}">{{ h }} hs</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-2">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">CONFIRMAR</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const draggables = document.querySelectorAll('.draggable');
    const containers = document.querySelectorAll('.drop-zone');

    draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', () => draggable.classList.add('dragging'));
        draggable.addEventListener('dragend', () => draggable.classList.remove('dragging'));
    });

    containers.forEach(container => {
        container.addEventListener('dragover', e => e.preventDefault());
        container.addEventListener('drop', e => {
            e.preventDefault();
            const draggable = document.querySelector('.dragging');
            if(!draggable) return;
            fetch('/mover_turno', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    id: draggable.getAttribute('data-id'),
                    dia_semana: container.getAttribute('data-dia'),
                    hora: container.getAttribute('data-hora')
                })
            }).then(() => location.reload());
        });
    });
</script>
{% endblock %}