{% extends 'layout.html' %}
{% block content %}
<style>
    .table-agenda {
        table-layout: fixed;
        border-collapse: separate;
        border-spacing: 2px;
    }
    .table-agenda th {
        font-size: 0.75rem;
        text-transform: uppercase;
        background-color: #212529 !important;
        color: white;
        text-align: center;
        padding: 8px 2px;
        width: 15%;
    }
    .col-hora { width: 70px !important; background-color: #f8f9fa; fw-bold; }
    
    .celda-turno {
        height: 100px; /* Altura fija para que la grilla sea simétrica */
        vertical-align: top;
        background-color: #ffffff;
        border: 1px solid #e9ecef;
        padding: 4px !important;
        overflow-y: auto;
    }
    
    .alumno-chip {
        font-size: 0.7rem;
        padding: 2px 4px;
        margin-bottom: 2px;
        background-color: #e7f1ff;
        border-left: 3px solid #0d6efd;
        border-radius: 3px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #084298;
        font-weight: 600;
    }
    .alumno-chip:hover { background-color: #cfe2ff; }
    .alumno-chip a { color: #dc3545; text-decoration: none; padding-left: 4px; }

    .btn-add-mini {
        font-size: 0.6rem;
        padding: 0px 4px;
        float: right;
        color: #adb5bd;
    }
</style>

<div class="card border-0 shadow-sm mb-3 no-print">
    <div class="card-body p-2 px-3 d-flex justify-content-between align-items-center">
        <h6 class="fw-bold mb-0"><i class="fas fa-th me-2 text-primary"></i>Panel de Control de Clases</h6>
        <div class="btn-group shadow-sm">
            <a href="/agenda?fecha={{ (inicio - timedelta(days=7)).strftime('%Y-%m-%d') }}" class="btn btn-light btn-sm border"><i class="fas fa-chevron-left"></i></a>
            <span class="btn btn-light btn-sm border fw-bold">{{ inicio.strftime('%d/%m') }} - {{ fin.strftime('%d/%m') }}</span>
            <a href="/agenda?fecha={{ (inicio + timedelta(days=7)).strftime('%Y-%m-%d') }}" class="btn btn-light btn-sm border"><i class="fas fa-chevron-right"></i></a>
        </div>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalTurno">
            <i class="fas fa-plus me-1"></i> Nuevo Turno
        </button>
    </div>
</div>

<div class="table-responsive shadow-sm rounded">
    <table class="table table-agenda mb-0">
        <thead>
            <tr>
                <th class="col-hora">HORA</th>
                <th>LUNES</th>
                <th>MARTES</th>
                <th>MIÉRCOLES</th>
                <th>JUEVES</th>
                <th>VIERNES</th>
                <th>SÁBADO</th>
            </tr>
        </thead>
        <tbody>
            {% for h in horarios %}
            <tr>
                <td class="text-center fw-bold align-middle bg-light small">{{ h }}</td>
                {% for dia in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'] %}
                <td class="celda-turno drop-zone" data-dia="{{ dia }}" data-hora="{{ h }}">
                    {% for t in turnos %}
                        {% if t.dia_semana == dia and (t.hora.strftime('%H:%M') if t.hora.strftime else t.hora) == h %}
                        <div class="alumno-chip draggable" draggable="true" data-id="{{ t.id }}">
                            <span class="text-truncate">{{ t.apellido }}</span>
                            <a href="/eliminar_turno/{{ t.id }}?fecha_ref={{ inicio.strftime('%Y-%m-%d') }}" onclick="return confirm('¿Quitar?')">×</a>
                        </div>
                        {% endif %}
                    {% endfor %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="modalTurno" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <form action="/agregar_turno" method="POST">
                <input type="hidden" name="fecha_inicio" value="{{ inicio.strftime('%Y-%m-%d') }}">
                <div class="modal-header bg-primary text-white py-2">
                    <h6 class="modal-title fw-bold">Asignar Alumno a Grilla</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Alumno</label>
                        <select name="alumno_id" class="form-select" required>
                            {% for a in alumnos %}<option value="{{ a.id }}">{{ a.apellido }}, {{ a.nombre }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="row g-2">
                        <div class="col-6 mb-2">
                            <label class="form-label small fw-bold">Día</label>
                            <select name="dia_semana" class="form-select">
                                {% for d in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'] %}<option value="{{ d }}">{{ d }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label small fw-bold">Hora</label>
                            <select name="hora" class="form-select">
                                {% for h in horarios %}<option value="{{ h }}">{{ h }} hs</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-2">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">CONFIRMAR HORARIO FIJO</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const draggables = document.querySelectorAll('.draggable');
    const containers = document.querySelectorAll('.drop-zone');

    draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', () => draggable.classList.add('dragging'));
        draggable.addEventListener('dragend', () => draggable.classList.remove('dragging'));
    });

    containers.forEach(container => {
        container.addEventListener('dragover', e => e.preventDefault());
        container.addEventListener('drop', e => {
            e.preventDefault();
            const draggable = document.querySelector('.dragging');
            if(!draggable) return;
            
            // Ahora mandamos también la hora al mover
            fetch('/mover_turno', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    id: draggable.getAttribute('data-id'),
                    dia_semana: container.getAttribute('data-dia'),
                    hora: container.getAttribute('data-hora') // Agregamos hora
                })
            }).then(() => location.reload());
        });
    });
</script>
{% endblock %}