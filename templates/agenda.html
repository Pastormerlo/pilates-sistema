{% extends 'layout.html' %}
{% block content %}
<style>
    .table-agenda { table-layout: fixed; border-spacing: 1px; }
    .table-agenda th {
        font-size: 0.7rem;
        background-color: #212529 !important;
        color: white;
        text-align: center;
        padding: 5px;
    }
    .col-hora { width: 60px !important; background-color: #f8f9fa; }
    
    .celda-turno {
        height: 110px;
        vertical-align: top;
        background-color: #ffffff;
        border: 1px solid #f0f0f0;
        padding: 2px !important;
    }

    /* Caja de Horario Completo */
    .box-completo {
        background-color: #198754;
        color: white;
        font-size: 0.7rem;
        font-weight: bold;
        text-align: center;
        padding: 15px 5px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: 100%;
    }
    .box-completo:hover { background-color: #146c43; }
    .box-completo i { font-size: 1.2rem; margin-bottom: 5px; }

    /* Lista de alumnos cuando hay lugar */
    .lista-alumnos {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .alumno-chip {
        font-size: 0.65rem;
        padding: 2px 5px;
        background-color: #f0f7ff;
        border-left: 3px solid #0d6efd;
        border-radius: 2px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #084298;
    }
    .cupo-indicador {
        font-size: 0.6rem;
        color: #6c757d;
        text-align: center;
        margin-top: 4px;
        font-weight: bold;
    }
</style>

<div class="card border-0 shadow-sm mb-3 no-print">
    <div class="card-body p-2 px-3 d-flex justify-content-between align-items-center">
        <h6 class="fw-bold mb-0 text-dark"><i class="fas fa-calendar-check me-2 text-success"></i>Control de Cupos</h6>
        <div class="btn-group shadow-sm">
            <a href="/agenda?fecha={{ (inicio - timedelta(days=7)).strftime('%Y-%m-%d') }}" class="btn btn-light btn-sm border"><i class="fas fa-chevron-left"></i></a>
            <span class="btn btn-light btn-sm border fw-bold small">{{ inicio.strftime('%d/%m') }}</span>
            <a href="/agenda?fecha={{ (inicio + timedelta(days=7)).strftime('%Y-%m-%d') }}" class="btn btn-light btn-sm border"><i class="fas fa-chevron-right"></i></a>
        </div>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalTurno">
            <i class="fas fa-plus"></i>
        </button>
    </div>
</div>

<div class="table-responsive shadow-sm rounded">
    <table class="table table-agenda mb-0 bg-white">
        <thead>
            <tr>
                <th class="col-hora">HORA</th>
                {% for d in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'] %}<th>{{ d }}</th>{% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for h in horarios %}
            <tr>
                <td class="text-center fw-bold align-middle bg-light" style="font-size: 0.75rem;">{{ h }}</td>
                {% for dia in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'] %}
                    {% set alumnos_turno = [] %}
                    {% for t in turnos %}
                        {% if t.dia_semana == dia and (t.hora.strftime('%H:%M') if t.hora.strftime else t.hora) == h %}
                            {% do alumnos_turno.append(t) %}
                        {% endif %}
                    {% endfor %}
                    
                    <td class="celda-turno drop-zone" data-dia="{{ dia }}" data-hora="{{ h }}">
                        {% if alumnos_turno|length >= 6 %}
                            <div class="box-completo" onclick="alert('Alumnos: {% for a in alumnos_turno %}{{ a.apellido }}{% if not loop.last %}, {% endif %}{% endfor %}')">
                                <i class="fas fa-users"></i>
                                CUPO COMPLETO
                                <div style="font-size: 0.6rem; opacity: 0.8;">(6 de 6)</div>
                            </div>
                        {% else %}
                            <div class="lista-alumnos">
                                {% for t in alumnos_turno %}
                                <div class="alumno-chip draggable" draggable="true" data-id="{{ t.id }}">
                                    <span class="text-truncate">{{ t.apellido }}</span>
                                    <a href="/eliminar_turno/{{ t.id }}?fecha_ref={{ inicio.strftime('%Y-%m-%d') }}" class="text-danger">×</a>
                                </div>
                                {% endfor %}
                            </div>
                            {% if alumnos_turno|length > 0 %}
                                <div class="cupo-indicador text-uppercase">
                                    {{ 6 - alumnos_turno|length }} Libres
                                </div>
                            {% endif %}
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="modalTurno" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <form action="/agregar_turno" method="POST">
                <input type="hidden" name="fecha_inicio" value="{{ inicio.strftime('%Y-%m-%d') }}">
                <div class="modal-header bg-primary text-white py-2">
                    <h6 class="modal-title fw-bold">Asignar Alumno</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Alumno</label>
                        <select name="alumno_id" class="form-select" required>
                            {% for a in alumnos %}<option value="{{ a.id }}">{{ a.apellido }}, {{ a.nombre }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="row g-2">
                        <div class="col-6 mb-2">
                            <label class="form-label small fw-bold">Día</label>
                            <select name="dia_semana" class="form-select">
                                {% for d in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'] %}<option value="{{ d }}">{{ d }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label small fw-bold">Hora</label>
                            <select name="hora" class="form-select">
                                {% for h in horarios %}<option value="{{ h }}">{{ h }} hs</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-2">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">CONFIRMAR</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const draggables = document.querySelectorAll('.draggable');
    const containers = document.querySelectorAll('.drop-zone');

    draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', () => draggable.classList.add('dragging'));
        draggable.addEventListener('dragend', () => draggable.classList.remove('dragging'));
    });

    containers.forEach(container => {
        container.addEventListener('dragover', e => e.preventDefault());
        container.addEventListener('drop', e => {
            e.preventDefault();
            const draggable = document.querySelector('.dragging');
            if(!draggable) return;
            fetch('/mover_turno', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    id: draggable.getAttribute('data-id'),
                    dia_semana: container.getAttribute('data-dia'),
                    hora: container.getAttribute('data-hora')
                })
            }).then(() => location.reload());
        });
    });
</script>
{% endblock %}