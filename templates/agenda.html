{% extends 'layout.html' %}
{% block content %}
<style>
    /* --- OPTIMIZACIÓN VISTA PC (GRILLA) --- */
    @media (min-width: 768px) {
        .table-agenda { 
            table-layout: fixed; 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
            border: 1px solid #dee2e6;
            display: table;
        }
        .table-agenda th {
            background-color: #212529 !important;
            color: white;
            text-align: center;
            padding: 12px 5px;
            font-size: 0.8rem;
            border: 1px solid #373b3e;
        }
        .table-agenda td {
            border: 1px solid #ebebeb;
            height: 100px; /* Altura fija para que sea una grilla real */
            vertical-align: top;
            padding: 0 !important;
        }
        .col-hora { 
            width: 70px; 
            background-color: #f8f9fa !important; 
            font-weight: bold;
            text-align: center;
            vertical-align: middle !important;
        }
        /* Efecto Cebra para no marearse */
        tr:nth-child(even) td:not(.col-hora) { background-color: #fafafa; }
        
        .vista-celu { display: none; }
    }

    /* --- OPTIMIZACIÓN VISTA CELULAR (LISTA) --- */
    @media (max-width: 767px) {
        .table-agenda { display: none; } 
        .vista-celu { display: block; }
        .dia-card { margin-bottom: 20px; border-radius: 10px; overflow: hidden; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dia-header { background: #0d6efd; color: white; padding: 12px; font-weight: bold; text-align: center; font-size: 1.1rem; }
        .hora-row { display: flex; padding: 12px; border-bottom: 1px solid #eee; background: white; }
        .hora-label { width: 60px; font-weight: bold; color: #495057; }
    }

    /* --- ESTILOS DE CHIPS Y DESPLEGABLES --- */
    details { width: 100%; height: 100%; }
    summary {
        list-style: none;
        padding: 8px 4px;
        cursor: pointer;
        text-align: center;
        font-weight: bold;
        font-size: 0.75rem;
    }
    summary::-webkit-details-marker { display: none; }

    .alumno-chip {
        font-size: 0.75rem;
        padding: 4px 8px;
        margin: 2px 4px;
        background: #ffffff;
        border: 1px solid #dee2e6;
        border-left: 3px solid #0d6efd;
        border-radius: 3px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 1px 1px 2px rgba(0,0,0,0.02);
    }
    
    /* Colores por estado de cupo */
    .cupo-vacio { color: #ced4da; }
    .cupo-medio { color: #0d6efd; background: #e7f1ff; }
    .cupo-lleno { color: #ffffff; background: #198754; }
</style>

<div class="card border-0 shadow-sm mb-3">
    <div class="card-body p-2 px-3 d-flex justify-content-between align-items-center">
        <h5 class="fw-bold mb-0 text-dark d-none d-md-block">Agenda de Clases</h5>
        <div class="btn-group shadow-sm">
            <a href="/agenda?fecha={{ (inicio - timedelta(days=7)).strftime('%Y-%m-%d') }}" class="btn btn-light btn-sm border"><i class="fas fa-chevron-left"></i></a>
            <span class="btn btn-white btn-sm border fw-bold text-primary">{{ inicio.strftime('%d/%m') }} al {{ fin.strftime('%d/%m') }}</span>
            <a href="/agenda?fecha={{ (inicio + timedelta(days=7)).strftime('%Y-%m-%d') }}" class="btn btn-light btn-sm border"><i class="fas fa-chevron-right"></i></a>
        </div>
        <button class="btn btn-primary btn-sm px-3 fw-bold" data-bs-toggle="modal" data-bs-target="#modalTurno">
            <i class="fas fa-plus me-1"></i> NUEVO TURNO
        </button>
    </div>
</div>

<div class="table-responsive d-none d-md-block shadow-sm rounded">
    <table class="table table-agenda mb-0 bg-white">
        <thead>
            <tr>
                <th class="col-hora">HORA</th>
                {% for d in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'] %}<th>{{ d }}</th>{% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for h in horarios %}
            <tr>
                <td class="col-hora small">{{ h }}</td>
                {% for dia in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'] %}
                    <td class="drop-zone" data-dia="{{ dia }}" data-hora="{{ h }}">
                        {% set alumnos_turno = [] %}
                        {% for t in turnos %}{% if t.dia_semana == dia and (t.hora.strftime('%H:%M') if t.hora.strftime else t.hora) == h %}{% set _ = alumnos_turno.append(t) %}{% endif %}{% endfor %}
                        
                        {% set cant = alumnos_turno|length %}
                        <details {% if cant > 0 %}open{% endif %}>
                            <summary class="{% if cant >= 6 %}cupo-lleno{% elif cant > 0 %}cupo-medio{% else %}cupo-vacio{% endif %}">
                                {% if cant >= 6 %}LLENO{% elif cant > 0 %}{{ cant }} / 6{% else %}-{% endif %}
                            </summary>
                            <div class="lista-alumnos">
                                {% for t in alumnos_turno %}
                                <div class="alumno-chip draggable" draggable="true" data-id="{{ t.id }}">
                                    <span class="text-truncate" title="{{ t.apellido }}">{{ t.apellido }}</span>
                                    <a href="/eliminar_turno/{{ t.id }}?fecha_ref={{ inicio.strftime('%Y-%m-%d') }}" class="text-danger ms-1" style="text-decoration:none;">×</a>
                                </div>
                                {% endfor %}
                            </div>
                        </details>
                    </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="vista-celu">
    {% for dia in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'] %}
    <div class="dia-card">
        <div class="dia-header">{{ dia }}</div>
        {% for h in horarios %}
            {% set alumnos_turno = [] %}
            {% for t in turnos %}{% if t.dia_semana == dia and (t.hora.strftime('%H:%M') if t.hora.strftime else t.hora) == h %}{% set _ = alumnos_turno.append(t) %}{% endif %}{% endfor %}
            
            {% if alumnos_turno|length > 0 %}
            <div class="hora-row">
                <div class="hora-label">{{ h }}</div>
                <div style="flex-grow: 1;">
                    {% for t in alumnos_turno %}
                    <div class="alumno-chip">
                        <span class="fw-bold">{{ t.apellido }}, {{ t.nombre }}</span>
                        <a href="/eliminar_turno/{{ t.id }}?fecha_ref={{ inicio.strftime('%Y-%m-%d') }}" class="text-danger"><i class="fas fa-trash-alt"></i></a>
                    </div>
                    {% endfor %}
                    <div class="text-end mt-1"><small class="badge bg-light text-muted border">{{ 6 - alumnos_turno|length }} Libres</small></div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
    {% endfor %}
</div>

<div class="modal fade" id="modalTurno" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <form action="/agregar_turno" method="POST">
                <input type="hidden" name="fecha_inicio" value="{{ inicio.strftime('%Y-%m-%d') }}">
                <div class="modal-header bg-dark text-white py-2">
                    <h6 class="modal-title fw-bold">Asignar Turno</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3">
                    <div class="mb-3">
                        <label class="small fw-bold">Alumno</label>
                        <select name="alumno_id" class="form-select" required>
                            {% for a in alumnos %}<option value="{{ a.id }}">{{ a.apellido }}, {{ a.nombre }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="small fw-bold">Día</label>
                            <select name="dia_semana" class="form-select">
                                {% for d in ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'] %}<option value="{{ d }}">{{ d }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="small fw-bold">Hora</label>
                            <select name="hora" class="form-select">
                                {% for h in horarios %}<option value="{{ h }}">{{ h }} hs</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">CONFIRMAR</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const draggables = document.querySelectorAll('.draggable');
    const containers = document.querySelectorAll('.drop-zone');
    draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', () => draggable.classList.add('dragging'));
        draggable.addEventListener('dragend', () => draggable.classList.remove('dragging'));
    });
    containers.forEach(container => {
        container.addEventListener('dragover', e => e.preventDefault());
        container.addEventListener('drop', e => {
            e.preventDefault();
            const draggable = document.querySelector('.dragging');
            if(!draggable) return;
            fetch('/mover_turno', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    id: draggable.getAttribute('data-id'),
                    dia_semana: container.getAttribute('data-dia'),
                    hora: container.getAttribute('data-hora')
                })
            }).then(() => location.reload());
        });
    });
</script>
{% endblock %}